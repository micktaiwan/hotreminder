"use strict";angular.module("hotreminderApp",["hotreminderApp.services.notification","hotreminderApp.services.db","hotreminderApp.filters.filterStateBy","hotreminderApp.directives.subject","hotreminderApp.directives.focusOn","google"]).config(["$routeProvider",function(a){a.when("/main",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/notification_test",{templateUrl:"views/notification_test.html",controller:"NotificationTestCtrl"}).when("/about",{templateUrl:"views/about.html",controller:"AboutCtrl"}).when("/:params",{templateUrl:"views/login.html",controller:"LoginCtrl"}).otherwise({redirectTo:"/main"})}]),angular.module("hotreminderApp").constant("CONFIG",{firebaseUrl:"https://hotreminder.firebaseio.com"}),angular.module("hotreminderApp.services.notification",[]).factory("Notification",["$rootScope",function(){return{types:{WARNING:{title:"HotReminder",icon:"http://cdn2.iconfinder.com/data/icons/lullacons/large-alert.png"},INFO:{title:"HotReminder",icon:"https://cdn2.iconfinder.com/data/icons/color-svg-vector-icons-2/512/information_info_about_question-128.png"}},enableNotifications:function(){0!=webkitNotifications.checkPermission()&&webkitNotifications.requestPermission()},addNotifications:function(a,b){webkitNotifications.createNotification(a.icon,a.title,b).show()}}}]),angular.module("hotreminderApp.services.db",[]).factory("Db",["$rootScope","$location","CONFIG",function(a,b,c){function d(a,b){a.$$phase||a.$root.$$phase?b():a.$apply(b)}var e,f=new Firebase(c.firebaseUrl+"/subjects"),g=new Firebase(c.firebaseUrl+"/lastupdates");return console.log("Connected to subjects db. Ref: "+f),{setUser:function(a){return e=a,console.log("connection: "+a.name+", "+a.id),a},getSubjects:function(b){f.once("value",function(c){null!==c.val()?d(a,function(){b(c.val())}):console.log("no values in DB")})},getLastUpdates:function(b){g.on("value",function(c){null!==c.val()?d(a,function(){b(c.val())}):console.log("no lastupdates in DB")})},onAddingSubject:function(b){f.off("child_added"),f.on("child_added",function(c){d(a,function(){b(c.val())})})},onDeletingSubject:function(b){f.off("child_removed"),f.on("child_removed",function(c){d(a,function(){b(c.val())})})},getUser:function(){return e},setState:function(a,b){f.child(a).child("states").child(e.id).update({state:b})},edit:function(a,b){f.child(a).update(b)},addSubject:function(a,b){console.log("Db.addSubject "+a+", "+b);var c=(new Date).getTime();b||(b="");var d={},h={},i={name:e.name,id:e.id},j=f.push().name();f.child(j).set({id:j,comments:h,creationDate:c,modificationDate:c,title:a,content:b,author:i,states:d});var k=g.push().name();return g.child(k).set({id:k,date:c,text:"added subject "+a,author:i,ref:"subjects",action:"add",object_id:j}),j},deleteSubject:function(a){var b={id:e.id,name:e.name},c=(new Date).getTime(),d=f.child(a);d.once("value",function(d){var e=g.push().name();g.child(e).set({id:e,date:c,text:"deleted subject "+d.val().title,author:b,ref:"subjects",action:"delete",object_id:a}),f.child(a).remove()})},addComment:function(a,b){if(!a)return console.log("no subject id"),null;var c={id:e.id,name:e.name},d=(new Date).getTime(),h=f.child(a).child("comments").push().name(),i={id:h,text:b,author:c,date:d};f.child(a).child("comments").child(h).set(i);var j=f.child(a);return j.once("value",function(b){var e=g.push().name();g.child(e).set({id:e,date:d,text:"commented on "+b.val().title,author:c,ref:"comments",action:"add",object_id:h,parent_id:a})}),i},deleteComment:function(a,b){var c={id:e.id,name:e.name},d=(new Date).getTime(),h=f.child(a);h.once("value",function(e){var f=g.push().name();g.child(f).set({id:f,date:d,text:"deleted a comment on "+e.val().title,author:c,ref:"comments",action:"delete",object_id:b,parent_id:a})}),f.child(a).child("comments").child(b).remove()},newSubject:function(b,f){var g=new Firebase(c.firebaseUrl+"/subjects/"+b.id+"/comments");return g.on("child_added",function(c){d(a,function(){f(b.id,c.val())})}),b.hasStateForCurrentUser=function(a){return this.states&&this.states[e.id]&&this.states[e.id].state&&this.states[e.id].state==a},b.hasNoState=function(){return!this.states||!this.states[e.id]||!this.states[e.id].state},b}}}]),angular.module("google",[]).factory("Google",["$rootScope","$routeParams",function(a,b){var c,d=function(a){if(!a)return!1;var b=a.match(/access_token=([^&]+)/);return!!b&&b[1]},e={host:"https://accounts.google.com/o/oauth2/auth",clientId:"156435181273.apps.googleusercontent.com"},f=function(c){var f=d(b.params);f?$.ajax({url:"https://www.googleapis.com/oauth2/v1/userinfo?access_token="+f,beforeSend:function(a){a.setRequestHeader("Authorization","OAuth "+f),a.setRequestHeader("Accept","application/json")},success:function(a){c(a)}}):a.authUrl=e.host+"?response_type=token&scope=https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fuserinfo.profile&client_id="+e.clientId+"&redirect_uri="+window.location};return{login:function(a,b){return f(function(d){d?(c=d,a(c)):b()}),c},logout:function(){c=null},getUser:function(){return c}}}]),angular.module("hotreminderApp.filters.filterStateBy",[]).filter("filterStateBy",["$rootScope","Db",function(a,b){return function(a,c){return a?a.filter(function(a){return"new"!=c||a.states&&a.states[b.getUser().id]&&a.states[b.getUser().id].state?a.hasStateForCurrentUser(c):!0}):[]}}]),angular.module("hotreminderApp.directives.subject",["ui"]).directive("subject",["$rootScope","$timeout","Db",function(a,b,c){return{restrict:"E",replace:!0,scope:{s:"=object",user:"=user",changed:"&"},templateUrl:"views/subject.html",controller:["$scope",function(a){a.s.show||(a.s.show=!1),a.setState=function(b){c.setState(a.s.id,b),a.s.states||(a.s.states={}),a.s.states[a.user.id]||(a.s.states[a.user.id]={}),a.s.states[a.user.id].state=b,a.s.showComments=!1},a.deleteSubject=function(){a.s.id?c.deleteSubject(a.s.id):console.log("no subject id")},a.addComment=function(){c.addComment(a.s.id,a.comment.text),a.comment.text=""},a.deleteComment=function(b){c.deleteComment(a.s.id,b),delete a.s.comments[b]}}],link:function(a,d){a.editorEnabled=!1,a.save=function(b){null!=b&&b.preventDefault(),a.s=angular.copy(a.edit),c.edit(a.s.id,{modificationDate:(new Date).getTime(),title:a.s.title,content:a.s.content}),a.editorEnabled=!1},a.cancel=function(b){null!=b&&b.preventDefault(),a.editorEnabled=!1},a.enableEditor=function(){a.edit=angular.copy(a.s),a.editorEnabled=!0,b(function(){d.find("input").focus().select()},20)}}}}]),angular.module("hotreminderApp.directives.focusOn",["ui"]).directive("focusOn",function(){return{restrict:"A",link:function(a,b,c){a.$watch(c.focusOn,function(){b[0].focus()})}}}),Date.prototype.getWeek=function(){var a=new Date(this.getFullYear(),0,1);return Math.ceil(((this-a)/864e5+a.getDay()+1)/7)},angular.module("hotreminderApp").controller("MainCtrl",["$rootScope","$scope","$location","Google","Db","Notification",function(a,b,c,d,e,f){a.current_date=(new Date).getTime(),a.weekNumber=(new Date).getWeek();var g=d.getUser();if(!g||!g.id)return c.path("/"),void 0;b.subjects=[],b.lastUpdates=[],b.user=g;var h=function(a){var c=null;return b.subjects.some(function(b){return b.id==a?(c=b,void 0):void 0}),c},i=function(a,b){console.log("Received comment for subject "+a);var c=h(a);c&&(c.comments||(c.comments={}),c.comments[b.id]=b,c.showComments=!0)};b.addNotification=function(a,b){f.addNotifications(a,b)},e.getLastUpdates(function(a){b.lastUpdates=[];for(var c in a)b.lastUpdates.push(a[c]);console.log(b.lastUpdates.length+" updates")}),e.onAddingSubject(function(a){console.log("Received subject "+a.title+" ("+a.id+")"),b.subjects.push(e.newSubject(a,i))}),e.onDeletingSubject(function(a){b.deleteSubject(a)}),b.addSubject=function(a,c){console.log("Adding subject "+a+" (id: "+e.addSubject(a,c)+")"),b.title="",b.content=""},b.deleteSubject=function(a){var c=h(a.id),d=b.subjects.indexOf(c);b.subjects.splice(d,1),console.log("Deleted "+a.title)}}]),angular.module("hotreminderApp").controller("LoginCtrl",["$rootScope","$location","Google","Db",function(a,b,c,d){c.login(function(){a.$apply(function(){var e=c.getUser();a.user=e,d.setUser(e),b.path("/main")})}),a.logout=function(){c.logout(),a.user=null,b.path("/")}}]),angular.module("hotreminderApp").controller("AboutCtrl",["$rootScope",function(){}]),angular.module("hotreminderApp").controller("NotificationTestCtrl",["$scope","Notification",function(a,b){a.enableNotifications=function(){b.enableNotifications()},a.addNotification=function(){b.addNotifications(b.types.WARNING,this.notification)}}]);