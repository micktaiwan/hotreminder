"use strict";angular.module("hotreminderApp",["hotreminderApp.services.notification","hotreminderApp.services.db","hotreminderApp.filters.filterStateBy","hotreminderApp.directives.subject","hotreminderApp.directives.focusOn","google"]).config(["$routeProvider",function(a){a.when("/main",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/notification_test",{templateUrl:"views/notification_test.html",controller:"NotificationTestCtrl"}).when("/about",{templateUrl:"views/about.html",controller:"AboutCtrl"}).when("/:params",{templateUrl:"views/login.html",controller:"LoginCtrl"}).otherwise({redirectTo:"/main"})}]),angular.module("hotreminderApp").constant("CONFIG",{firebaseUrl:"https://hotreminder.firebaseio.com"}),angular.module("hotreminderApp.services.notification",[]).factory("Notification",["$rootScope",function(){return{types:{WARNING:{title:"HotReminder",icon:"http://cdn2.iconfinder.com/data/icons/lullacons/large-alert.png"},INFO:{title:"HotReminder",icon:"https://cdn2.iconfinder.com/data/icons/color-svg-vector-icons-2/512/information_info_about_question-128.png"}},enableNotifications:function(){0!=webkitNotifications.checkPermission()&&webkitNotifications.requestPermission()},addNotifications:function(a,b){webkitNotifications.createNotification(a.icon,a.title,b).show()}}}]),angular.module("hotreminderApp.services.db",[]).factory("Db",["$rootScope","$location","CONFIG",function(a,b,c){function d(a,b){a.$$phase||a.$root.$$phase?b():a.$apply(b)}var e,f=new Firebase(c.firebaseUrl+"/subjects");return console.log("Connected to subjects db. Ref: "+f),{setUser:function(a){return e=a,console.log("connection: "+a.name+", "+a.id),a},getSubjects:function(b){f.on("value",function(c){null!==c.val()?d(a,function(){b(c.val())}):console.log("no values in DB")})},getUser:function(){return e},setState:function(a,b){f.child(a).child("states").child(e.id).update({state:b})},edit:function(a,b){f.child(a).update(b)},addSubject:function(a,b){console.log("Db.addSubject "+a+", "+b);var c=(new Date).getTime();b||(b="");var d={};f.push({creationDate:c,modificationDate:c,title:a,content:b,author:{name:e.name,id:e.id},states:d})},deleteSubject:function(a){f.child(a).remove()},addComment:function(a,b){var c=f.child(a).child("comments").push().name();f.child(a).child("comments").child(c).set({id:c,text:b,author:{id:e.id,name:e.name},date:(new Date).getTime()})},deleteComment:function(a,b){f.child(a).child("comments").child(b).remove()},newSubject:function(a,b){var c={};for(var d in b)c[d]=b[d];return c.id=a,c.hasStateForCurrentUser=function(a){return this.states&&this.states[e.id]&&this.states[e.id].state&&this.states[e.id].state==a},c.hasNoState=function(){return!this.states||!this.states[e.id]||!this.states[e.id].state},c}}}]),angular.module("google",[]).factory("Google",["$rootScope","$routeParams",function(a,b){var c,d=function(a){if(!a)return!1;var b=a.match(/access_token=([^&]+)/);return!!b&&b[1]},e={host:"https://accounts.google.com/o/oauth2/auth",clientId:"156435181273.apps.googleusercontent.com"},f=function(c){var f=d(b.params);f?$.ajax({url:"https://www.googleapis.com/oauth2/v1/userinfo?access_token="+f,beforeSend:function(a){a.setRequestHeader("Authorization","OAuth "+f),a.setRequestHeader("Accept","application/json")},success:function(a){c(a)}}):a.authUrl=e.host+"?response_type=token&scope=https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fuserinfo.profile&client_id="+e.clientId+"&redirect_uri="+window.location};return{login:function(a,b){return f(function(d){d?(c=d,a(c)):b()}),c},logout:function(){c=null},getUser:function(){return c}}}]),angular.module("hotreminderApp.filters.filterStateBy",[]).filter("filterStateBy",["$rootScope","Db",function(a,b){return function(a,c){return a?a.filter(function(a){return"new"!=c||a.states&&a.states[b.getUser().id]&&a.states[b.getUser().id].state?a.hasStateForCurrentUser(c):!0}):[]}}]),angular.module("hotreminderApp.directives.subject",["ui"]).directive("subject",["$timeout","Db",function(a,b){return{restrict:"E",replace:!0,scope:{s:"=object",user:"=user",changed:"&"},templateUrl:"views/subject.html",controller:["$scope",function(a){a.s.show=!1,a.setState=function(c){b.setState(a.s.id,c)},a.deleteSubject=function(){b.deleteSubject(a.s.id)},a.addComment=function(){b.addComment(a.s.id,a.comment.text)},a.deleteComment=function(c){b.deleteComment(a.s.id,c.id)}}],link:function(c,d){c.editorEnabled=!1,c.save=function(a){null!=a&&a.preventDefault(),c.s=angular.copy(c.edit),b.edit(c.s.id,{modificationDate:(new Date).getTime(),title:c.s.title,content:c.s.content}),c.editorEnabled=!1},c.cancel=function(a){null!=a&&a.preventDefault(),c.editorEnabled=!1},c.enableEditor=function(){c.edit=angular.copy(c.s),c.editorEnabled=!0,a(function(){d.find("input").focus().select()},20)}}}}]),angular.module("hotreminderApp.directives.focusOn",["ui"]).directive("focusOn",function(){return{restrict:"A",link:function(a,b,c){a.$watch(c.focusOn,function(){b[0].focus()})}}}),Date.prototype.getWeek=function(){var a=new Date(this.getFullYear(),0,1);return Math.ceil(((this-a)/864e5+a.getDay()+1)/7)},angular.module("hotreminderApp").controller("MainCtrl",["$rootScope","$scope","$location","Google","Db","Notification",function(a,b,c,d,e,f){a.current_date=(new Date).getTime(),a.weekNumber=(new Date).getWeek();var g=d.getUser();return g&&g.id?(b.subjects=[],b.user=g,b.addNotification=function(a,b){f.addNotifications(a,b)},e.getSubjects(function(a){b.subjects=[];for(var c in a)b.subjects.push(e.newSubject(c,a[c]));console.log(b.subjects.length+" subjects")}),b.addSubject=function(a,c){e.addSubject(a,c),b.title="",b.content=""},void 0):(c.path("/"),void 0)}]),angular.module("hotreminderApp").controller("LoginCtrl",["$rootScope","$location","Google","Db",function(a,b,c,d){c.login(function(){a.$apply(function(){var e=c.getUser();a.user=e,d.setUser(e),b.path("/main")})}),a.logout=function(){c.logout(),a.user=null,b.path("/")}}]),angular.module("hotreminderApp").controller("AboutCtrl",["$rootScope",function(){}]),angular.module("hotreminderApp").controller("NotificationTestCtrl",["$scope","Notification",function(a,b){a.enableNotifications=function(){b.enableNotifications()},a.addNotification=function(){b.addNotifications(b.types.WARNING,this.notification)}}]);